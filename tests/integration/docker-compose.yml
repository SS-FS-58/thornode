version: '3'

services:
  rspec:
    build: docker-ruby
    image: statechain-ruby
    links:
      - "daemon:daemon"
      - "api:api"
    depends_on:
      - daemon
      - api
    volumes:
      - ~:/root
      - ../..:/root/go/src/gitlab.com/thorchain/statechain
    working_dir: /root/go/src/gitlab.com/thorchain/statechain
    environment:
      APIHOST: api
      APIPORT: 1317
      DAEMONHOST: daemon
      DAEMONPORT: 26657
    command: make -C ./tests/integration install setup wait-for-blockchain test
  daemon:
    build: .
    image: statechain
    volumes:
      - ~:/root
      - ../..:/root/go/src/gitlab.com/thorchain/statechain:rw
    working_dir: /root/go/src/gitlab.com/thorchain/statechain
    ports:
      - "26657:26657"
    expose:
      - "26657"
    command: make install reset start-daemon-compose
  api:
    build: .
    image: statechain
    volumes:
      - ~:/root
      - ../..:/root/go/src/gitlab.com/thorchain/statechain
    working_dir: /root/go/src/gitlab.com/thorchain/statechain
    ports:
      - "1317:1317"
    command: make install start-rest-compose
