version: '3'

services:
  observer:
    hostname: observer
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    restart: unless-stopped
    environment:
      CHAIN_HOST: thor-api:1317
    entrypoint:
      /docker/scripts/observer.sh
    depends_on:
      - thor-api
    links:
      - thor-api
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_1/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_1/.thorcli:/root/.thorcli
    command: ["observed", "-c", "/etc/observe/observed/config.json"]

  signer:
    hostname: signer
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    restart: unless-stopped
    environment:
      CHAIN_HOST: thor-api:1317
      RPC_HOST: thor-daemon:26657
    entrypoint:
      /docker/scripts/signer.sh
    depends_on:
      - tssKeygen
      - tssSign
      - thor-api
    links:
      - tssKeygen
      - tssSign
      - thor-api
    depends_on:
      - thor-api
    links:
      - thor-api
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - /tmp/genesis:/tmp/shared
      - ${HOME}/.thornode/genesis_1/keys:/root/.signer
    command: ["signd", "-c", "/etc/observe/signd/config.json"]

  thor-daemon:
    hostname: thor-daemon
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    environment:
      NODES: 4
      SEED: thor-daemon
    depends_on:
      - tssKeygen
    links:
      - tssKeygen
    ports:
      - "26657:26657"
      - "26656:26656"
    entrypoint:
      /docker/scripts/genesis.sh
    volumes:
      - /tmp/genesis:/tmp/shared
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_1/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_1/.thorcli:/root/.thorcli
      - ${HOME}/.thornode/genesis_1/keys:/root/.signer
    command: ["thord", "start", "--rpc.laddr", "tcp://0.0.0.0:26657"]

  thor-api:
    hostname: thor-api
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    depends_on:
      - thor-daemon
    links:
      - thor-daemon
    image: registry.gitlab.com/thorchain/bepswap/thornode
    environment:
      CHAIN_DAEMON: thor-daemon:26657
    ports:
      - "1317:1317"
    entrypoint:
      /docker/scripts/rest.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_1/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_1/.thorcli:/root/.thorcli
    command: ["thorcli", "rest-server", "--chain-id", "thorchain", "--laddr", "tcp://0.0.0.0:1317", "--node", "tcp://thor-daemon:26657"]

  tssKeygen:
    hostname: tssKeygen
    image: registry.gitlab.com/thorchain/tss/multi-party-ecdsa-docker
    environment:
      PARTIES: 4
      THRESHOLD: 3
      BOOTSTRAPNODE: ""
      SIGNERSERVER: "0.0.0.0:8321"
      KEYGENSERVER: "0.0.0.0:8322"
      PARTYNUM: 1
      TSS_NODE_ID: "waiting"
      CONFIGFILE: ~/.tss/config/config_1.json
    entrypoint:
      /docker/scripts/tss_keygen.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/standalone/.tss:/root/.tss
    command: "tss_keygen ~/.tss/config/config_1.json ~/.tss/private.key /ip4/tssSign/tcp/5455"

  tssSign:
    hostname: tssSign
    image: registry.gitlab.com/thorchain/tss/multi-party-ecdsa-docker
    environment:
      CONFIGFILE: ~/.tss/config/config_1.json
    entrypoint:
      /docker/scripts/tss_sign.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/standalone/.tss:/root/.tss
    command: "tss_sign ~/.tss/private.key ~/.tss/config/config_1.json /ip4/tssKeygen/tcp/5455"

  observer2:
    hostname: observer2
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    restart: unless-stopped
    environment:
      CHAIN_HOST: thor-api2:1317
    entrypoint:
      /docker/scripts/observer.sh
    depends_on:
      - thor-api2
    links:
      - thor-api2
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_2/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_2/.thorcli:/root/.thorcli
    command: ["observed", "-c", "/etc/observe/observed/config.json"]

  signer2:
    hostname: signer2
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    restart: unless-stopped
    environment:
      CHAIN_HOST: thor-api2:1317
      RPC_HOST: thor-daemon2:26657
    entrypoint:
      /docker/scripts/signer.sh
    depends_on:
      - tssKeygen2
      - tssSign2
      - thor-api2
    links:
      - tssKeygen2
      - tssSign2
      - thor-api2
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - /tmp/genesis:/tmp/shared
      - ${HOME}/.thornode/genesis_2/keys:/root/.signer
    command: ["signd", "-c", "/etc/observe/signd/config.json"]

  thor-daemon2:
    hostname: thor-daemon2
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    environment:
      NODES: 4
      SEED: thor-daemon
    depends_on:
      - tssKeygen2
    links:
      - tssKeygen2
    entrypoint:
      /docker/scripts/genesis.sh
    volumes:
      - /tmp/genesis:/tmp/shared
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_2/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_2/.thorcli:/root/.thorcli
      - ${HOME}/.thornode/genesis_2/keys:/root/.signer
    command: ["thord", "start", "--rpc.laddr", "tcp://0.0.0.0:26657"]

  thor-api2:
    hostname: thor-api2
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    depends_on:
      - thor-daemon2
    links:
      - thor-daemon2
    image: registry.gitlab.com/thorchain/bepswap/thornode
    environment:
      CHAIN_DAEMON: thor-daemon2:26657
    entrypoint:
      /docker/scripts/rest.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_2/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_2/.thorcli:/root/.thorcli
    command: ["thorcli", "rest-server", "--chain-id", "thorchain", "--laddr", "tcp://0.0.0.0:1317", "--node", "tcp://thor-daemon:26657"]

  tssKeygen2:
    hostname: tssKeygen2
    image: registry.gitlab.com/thorchain/tss/multi-party-ecdsa-docker
    environment:
      PARTIES: 4
      THRESHOLD: 3
      BOOTSTRAPNODE: "/ip4/tssKeygen/tcp/5433"
      SIGNERSERVER: "0.0.0.0:8321"
      KEYGENSERVER: "0.0.0.0:8322"
      PARTYNUM: 2
      TSS_NODE_ID: "waiting"
      CONFIGFILE: ~/.tss/config/config_2.json
    entrypoint:
      /docker/scripts/tss_keygen.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/standalone/.tss:/root/.tss
    command: "tss_keygen ~/.tss/config/config_2.json ~/.tss/private.key /ip4/tssSign2/tcp/5455"

  tssSign2:
    hostname: tssSign2
    image: registry.gitlab.com/thorchain/tss/multi-party-ecdsa-docker
    environment:
      CONFIGFILE: ~/.tss/config/config_2.json
    entrypoint:
      /docker/scripts/tss_sign.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/standalone/.tss:/root/.tss
    command: "tss_sign ~/.tss/private.key ~/.tss/config/config_2.json /ip4/tssKeygen2/tcp/5455"


  observer3:
    hostname: observer3
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    restart: unless-stopped
    environment:
      CHAIN_HOST: thor-api3:1317
    entrypoint:
      /docker/scripts/observer.sh
    depends_on:
      - thor-api3
    links:
      - thor-api3
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_3/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_3/.thorcli:/root/.thorcli
    command: ["observed", "-c", "/etc/observe/observed/config.json"]

  signer3:
    hostname: signer3
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    restart: unless-stopped
    environment:
      CHAIN_HOST: thor-api3:1317
      RPC_HOST: thor-daemon3:26657
    entrypoint:
      /docker/scripts/signer.sh
    depends_on:
      - tssKeygen3
      - tssSign3
      - thor-api3
    links:
      - tssKeygen3
      - tssSign3
      - thor-api3
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - /tmp/genesis:/tmp/shared
      - ${HOME}/.thornode/genesis_3/keys:/root/.signer
    command: ["signd", "-c", "/etc/observe/signd/config.json"]

  thor-daemon3:
    hostname: thor-daemon3
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    environment:
      NODES: 4
      SEED: thor-daemon
    depends_on:
      - tssKeygen3
    links:
      - tssKeygen3
    entrypoint:
      /docker/scripts/genesis.sh
    volumes:
      - /tmp/genesis:/tmp/shared
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_3/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_3/.thorcli:/root/.thorcli
      - ${HOME}/.thornode/genesis_3/keys:/root/.signer
    command: ["thord", "start", "--rpc.laddr", "tcp://0.0.0.0:26657"]

  thor-api3:
    hostname: thor-api3
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    depends_on:
      - thor-daemon3
    links:
      - thor-daemon3
    image: registry.gitlab.com/thorchain/bepswap/thornode
    environment:
      CHAIN_DAEMON: thor-daemon3:26657
    entrypoint:
      /docker/scripts/rest.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_3/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_3/.thorcli:/root/.thorcli
    command: ["thorcli", "rest-server", "--chain-id", "thorchain", "--laddr", "tcp://0.0.0.0:1317", "--node", "tcp://thor-daemon:26657"]

  tssKeygen3:
    hostname: tssKeygen3
    image: registry.gitlab.com/thorchain/tss/multi-party-ecdsa-docker
    environment:
      PARTIES: 4
      THRESHOLD: 3
      BOOTSTRAPNODE: "/ip4/tssKeygen/tcp/5433"
      SIGNERSERVER: "0.0.0.0:8321"
      KEYGENSERVER: "0.0.0.0:8322"
      PARTYNUM: 3
      TSS_NODE_ID: "waiting"
      CONFIGFILE: ~/.tss/config/config_3.json
    entrypoint:
      /docker/scripts/tss_keygen.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/standalone/.tss:/root/.tss
    command: "tss_keygen ~/.tss/config/config_3.json ~/.tss/private.key /ip4/tssSign3/tcp/5455"

  tssSign3:
    hostname: tssSign3
    image: registry.gitlab.com/thorchain/tss/multi-party-ecdsa-docker
    environment:
      CONFIGFILE: ~/.tss/config/config_3.json
    entrypoint:
      /docker/scripts/tss_sign.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/standalone/.tss:/root/.tss
    command: "tss_sign ~/.tss/private.key ~/.tss/config/config_3.json /ip4/tssKeygen3/tcp/5455"

  observer4:
    hostname: observer4
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    restart: unless-stopped
    environment:
      CHAIN_HOST: thor-api4:1317
    entrypoint:
      /docker/scripts/observer.sh
    depends_on:
      - thor-api4
    links:
      - thor-api4
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_4/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_4/.thorcli:/root/.thorcli
    command: ["observed", "-c", "/etc/observe/observed/config.json"]

  signer4:
    hostname: signer4
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    restart: unless-stopped
    environment:
      CHAIN_HOST: thor-api4:1317
      RPC_HOST: thor-daemon4:26657
    depends_on:
      - tssKeygen4
      - tssSign4
    links:
      - tssKeygen4
      - tssSign4
    entrypoint:
      /docker/scripts/signer.sh
    depends_on:
      - thor-api4
    links:
      - thor-api4
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - /tmp/genesis:/tmp/shared
      - ${HOME}/.thornode/genesis_4/keys:/root/.signer
    command: ["signd", "-c", "/etc/observe/signd/config.json"]

  thor-daemon4:
    hostname: thor-daemon4
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    image: registry.gitlab.com/thorchain/bepswap/thornode
    environment:
      NODES: 4
      SEED: thor-daemon
    entrypoint:
      /docker/scripts/genesis.sh
    depends_on:
      - tssKeygen4
    links:
      - tssKeygen4
    volumes:
      - /tmp/genesis:/tmp/shared
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_4/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_4/.thorcli:/root/.thorcli
      - ${HOME}/.thornode/genesis_4/keys:/root/.signer
    command: ["thord", "start", "--rpc.laddr", "tcp://0.0.0.0:26657"]

  thor-api4:
    hostname: thor-api4
    build:
      context: ../..
      dockerfile: ./build/docker/Dockerfile
    depends_on:
      - thor-daemon4
    links:
      - thor-daemon4
    image: registry.gitlab.com/thorchain/bepswap/thornode
    environment:
      CHAIN_DAEMON: thor-daemon4:26657
    entrypoint:
      /docker/scripts/rest.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/genesis_4/.thord:/root/.thord
      - ${HOME}/.thornode/genesis_4/.thorcli:/root/.thorcli
    command: ["thorcli", "rest-server", "--chain-id", "thorchain", "--laddr", "tcp://0.0.0.0:1317", "--node", "tcp://thor-daemon:26657"]

  tssKeygen4:
    hostname: tssKeygen4
    image: registry.gitlab.com/thorchain/tss/multi-party-ecdsa-docker
    environment:
      PARTIES: 4
      THRESHOLD: 3
      BOOTSTRAPNODE: "/ip4/tssKeygen/tcp/5433"
      SIGNERSERVER: "0.0.0.0:8321"
      KEYGENSERVER: "0.0.0.0:8322"
      PARTYNUM: 4
      TSS_NODE_ID: "waiting"
      CONFIGFILE: ~/.tss/config/config_4.json
    entrypoint:
      /docker/scripts/tss_keygen.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/standalone/.tss:/root/.tss
    command: "tss_keygen ~/.tss/config/config_4.json ~/.tss/private.key /ip4/tssSign4/tcp/5455"

  tssSign4:
    hostname: tssSign4
    image: registry.gitlab.com/thorchain/tss/multi-party-ecdsa-docker
    environment:
      CONFIGFILE: ~/.tss/config/config_4.json
    entrypoint:
      /docker/scripts/tss_sign.sh
    volumes:
      - ${PWD}/../scripts:/docker/scripts
      - ${HOME}/.thornode/standalone/.tss:/root/.tss
    command: "tss_sign ~/.tss/private.key ~/.tss/config/config_4.json /ip4/tssKeygen4/tcp/5455"
