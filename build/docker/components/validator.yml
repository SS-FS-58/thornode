version: '3'

services:
  bifrost:
    hostname: bifrost
    network_mode: "host"
    build:
      context: ../../..
      dockerfile: ./build/docker/Dockerfile
      args:
        TAGS: ${TAG:-mainnet}
    image: registry.gitlab.com/thorchain/thornode:${TAG:-latest}
    restart: unless-stopped
    environment:
      NET: ${NET}
      CHAIN_API: localhost:1317
      CHAIN_RPC: localhost:26657
      BINANCE_HOST: ${BINANCE_HOST:-http://localhost:26660}
      TSS_HOST: localhost
    entrypoint:
      /docker/scripts/bifrost.sh
    depends_on:
      - thor-api
      - tss
    volumes:
      - "../../scripts:/docker/scripts"
      - ${HOME}/.thornode/validator/.thord:/root/.thord
      - ${HOME}/.thornode/validator/.thorcli:/root/.thorcli
    command: ["bifrost", "-c", "/etc/bifrost/config.json"]

  thor-daemon:
    hostname: thor-daemon
    network_mode: "host"
    build:
      context: ../../..
      dockerfile: ./build/docker/Dockerfile
      args:
        TAGS: ${TAG:-mainnet}
    image: registry.gitlab.com/thorchain/thornode:${TAG:-latest}
    restart: unless-stopped
    environment:
      NET: ${NET}
      PEER: ${PEER}
      TSSPRIVKEY: /root/.tss/private.key
    ports:
      - "26657:26657"
      - "26656:26656"
    expose:
      - "26656"
      - "26657"
    depends_on:
      - tss
    entrypoint:
      /docker/scripts/validator.sh
    volumes:
      - "../../scripts:/docker/scripts"
      - ${HOME}/.thornode/validator/.thord:/root/.thord
      - ${HOME}/.thornode/validator/.thorcli:/root/.thorcli
      - ${HOME}/.thornode/validator/.tss:/root/.tss
    command: ["thord", "start", "--log_level", "main:info,state:debug,*:error", "--rpc.laddr", "tcp://0.0.0.0:26657"]

  thor-api:
    hostname: thor-api
    network_mode: "host"
    build:
      context: ../../..
      dockerfile: ./build/docker/Dockerfile
      args:
        TAGS: ${TAG:-mainnet}
    image: registry.gitlab.com/thorchain/thornode:${TAG:-latest}
    restart: unless-stopped
    environment:
      NET: ${NET}
      CHAIN_DAEMON: localhost:26657
    ports:
      - "1317:1317"
    expose:
      - "1317"
    entrypoint:
      /docker/scripts/rest.sh
    volumes:
      - "../../scripts:/docker/scripts"
      - ${HOME}/.thornode/validator/.thord:/root/.thord
      - ${HOME}/.thornode/validator/.thorcli:/root/.thorcli
    command: ["thorcli", "rest-server", "--chain-id", "thorchain", "--laddr", "tcp://0.0.0.0:1317", "--node", "tcp://localhost:26657"]

  tss:
    hostname: tss
    network_mode: "host"
    image: registry.gitlab.com/thorchain/tss/go-tss
    restart: unless-stopped
    environment:
      NET: ${NET}
      SEED: ${PEER}
      SEEDHTTPPORT: 4040
      SEEDP2PPORT: 5040
      TSSHTTPPORT: 4040
      TSSP2PPORT: 5040
      PRIVKEY: /root/.tss/private.key
    expose:
      - "5040"
    ports:
      - "5040:5040"
    entrypoint:
      /docker/scripts/tss.sh
    volumes:
      - "../../scripts:/docker/scripts"
      - ${HOME}/.thornode/validator/.tss:/root/.tss
